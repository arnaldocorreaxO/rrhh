{% extends 'list.html' %}
{% load static %}
{% block content %}




  <h3>ğŸ•’ Procesar marcaciones</h3>

    <div class="container-fluid">
        <div class="row">
            <!-- Columna izquierda: filtros -->
            <div class="col-md-4">
                <form id="marcaciones-form" class="form-horizontal">
                    {% csrf_token %}

                    <div class="form-group">
                    <label for="sede">ğŸ¢ Sede:</label>
                    <select name="sede" id="sede" class="form-control" required>
                        <option value="CEN">Central</option>
                        <option value="VTA">Villeta</option>
                        <option value="VMI">VallemÃ­</option>
                    </select>
                    </div>

                    <div class="form-group">
                    <label for="fecha_desde">ğŸ“… Fecha desde:</label>
                    <input type="date" name="fecha_desde" id="fecha_desde" class="form-control" required>
                    </div>

                    <div class="form-group">
                    <label for="fecha_hasta">ğŸ“… Fecha hasta:</label>
                    <input type="date" name="fecha_hasta" id="fecha_hasta" class="form-control" required>
                    </div>

                    <div class="form-group d-flex justify-content-between">
                    <button type="button" id="verificar-btn" class="btn btn-primary">Verificar</button>
                    <button type="submit" class="btn btn-success">Procesar</button>
                    </div>
                </form>
            </div>

            <!-- Columna derecha: resultados -->
            <div class="col-md-8">
                <div class="form-group">
                    <label for="resultado">ğŸ“‹ Resultado del procesamiento:</label>
                    <textarea id="resultado" name="resultado" class="form-control" rows="16" readonly></textarea>
                </div>
            </div>
        </div>
    </div>


    <!-- JavaScript para manejar el procesamiento y la verificaciÃ³n -->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const hoy = new Date();
                const yyyy = hoy.getFullYear();
                const mm = String(hoy.getMonth() + 1).padStart(2, '0');
                const dd = String(hoy.getDate()).padStart(2, '0');

                const fechaDesde = document.getElementById("fecha_desde");
                const fechaHasta = document.getElementById("fecha_hasta");
                const textarea = document.getElementById("resultado");

                // Establecer fechas por defecto
                const defaultDesde = `${yyyy}-${mm}-01`;
                const defaultHasta = `${yyyy}-${mm}-${dd}`;
                fechaDesde.value = defaultDesde;
                fechaHasta.value = defaultHasta;

                const form = document.getElementById("marcaciones-form");
                const verificarBtn = document.getElementById("verificar-btn");

                function handleStream(url, formData) {
                textarea.value = "â³ Procesando...\n";
                fetch(url, {
                    method: "POST",
                    body: formData,
                }).then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");

                    function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) return;
                        textarea.value += decoder.decode(value);
                        textarea.scrollTop = textarea.scrollHeight;
                        read();
                    });
                    }

                    read();
                }).catch(error => {
                    textarea.value += `âŒ Error de red: ${error}\n`;
                });
                }

                // Procesar marcaciones
                form.addEventListener("submit", function (e) {
                e.preventDefault();
                const formData = new FormData(form);
                handleStream("{% url 'procesar_marcaciones_stream' %}", formData);
                });

                // Verificar marcaciones
                verificarBtn.addEventListener("click", function () {
                const formData = new FormData(form);
                handleStream("{% url 'verificar_marcaciones' %}", formData);
                });
            });
        </script>
{% comment %} </body>
</html> {% endcomment %}
{%endblock %}